# インデントベースと新しい制御構造 {ignore=true}

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [ドキュメント参照先](#ドキュメント参照先)
- [Optional Braces](#optional-braces)
- [New Control Syntax](#new-control-syntax)
- [Scala 3 Syntax Rewriting](#scala-3-syntax-rewriting)

<!-- /code_chunk_output -->

## ドキュメント参照先

ここからは基本的にドキュメントの参照先を記載するので、
そのドキュメントと、このリポジトリの対応するサンプルコードを併せて見ながら進めたいと思います。

Reference からはこちらを
- [Optional Braces](https://dotty.epfl.ch/docs/reference/other-new-features/indentation.html)
- [New Control Syntax](https://dotty.epfl.ch/docs/reference/other-new-features/control-syntax.html)

Migration guide からはこちらを参照します
- [Scala 3 Syntax Rewriting](https://scalacenter.github.io/scala-3-migration-guide/docs/scala-3-syntax-rewriting.html)

## Optional Braces

https://dotty.epfl.ch/docs/reference/other-new-features/indentation.html

- 中括弧 `{...}` はオプションになった
- 不正なインデントはコンパイラが warning を出力する
- インデントブロックのすべての式や文が正確に並ぶことを要求しているわけではない
- コンパイラは内部的に、特定の予約語や改行時に `<indent>` または `<outdent>` トークンを自動的に挿入。文法的には、`<indent>` トークンと `<outdent>` トークンのペアは、中括弧 `{` と `}` のペアと同じ効果を持つ
- class、trait、object などに `:` をつけると次の行からボディを定義できる
- 同じソースファイル内でスペースとタブを混在させるのは避けるべき
- `match` や `catch` の 中括弧も省略可能
- インデントの範囲が「一目見て」すぐには分からないコードには、`end` マーカーを付ける
  - [ガイドライン](https://dotty.epfl.ch/docs/reference/other-new-features/indentation.html#the-end-marker) 参照
- コンパイラオプションの `rewrite` を使用することでコンパイラが自動的に書き換えてくれる
  - `-indent`、`-no-indent` を組み合わせる
- 高階関数は例外で、中括弧有りで書く
  ```
  xs.map { x =>
    ...
  }
  ```
  - ただし、`-Yindent-colons` を付けることで、この制限すら外すこともできる

なお、公式ドキュメントのインデントが全体的に 3 space になってるのは、[実験的な試み](https://github.com/lampepfl/dotty/pull/10878) みたいです
> The switch to 3 space is an experiment, we can undo it separately if we don;t like it.

## New Control Syntax

https://dotty.epfl.ch/docs/reference/other-new-features/control-syntax.html

-  "quiet" シンタックスが追加された
- `if` 式は、`then` を書く場合は条件に括弧を付けなくても良い
- `while` loop の条件は、`do` の後に続く場合は括弧を付けずに書くことができる
- `for` 式の列挙子は、`yield` や `do` の後に続く場合は、括弧や中括弧を入れずに書くことができる
- `for` 式の `do` は for-loop を表現している
- `catch` と同一行に 1つの `case` を書ける
- `catch` の `case` が複数の場合は、中括弧に入れるか、インデントブロックにしなければならない
- コンパイラオプションの `rewrite` を使用することでコンパイラが自動的に書き換えてくれる
  - `-new-syntax`、`-old-syntax` を組み合わせる

## Scala 3 Syntax Rewriting

https://scalacenter.github.io/scala-3-migration-guide/docs/scala-3-syntax-rewriting.html

- Syntax
  - インデントベース : `significant indentation based syntax (SIB syntax)`
  - Scala2 系の書き方 : `Classic syntax`
- Control structures
  - `if` や `for` などの新しい書き方 : `New control structures`
  - Scala2 系の書き方 : `Classic control structures`
- 1つのコードベースでこれらが混在するのは良くない
- Scala3 のコンパイラには自動で書き換えてくれる機能がある
