# インデントベースと新しい制御構造 {ignore=true}

<!-- @import "[TOC]" {cmd="toc" depthFrom=1 depthTo=6 orderedList=false} -->

<!-- code_chunk_output -->

- [ドキュメント参照先](#ドキュメント参照先)
- [Optional Braces](#optional-braces)
  - [要点](#要点)
- [New Control Syntax](#new-control-syntax)
  - [要点](#要点-1)
- [Scala 3 Syntax Rewriting](#scala-3-syntax-rewriting)

<!-- /code_chunk_output -->

## ドキュメント参照先

ここからは基本的にドキュメントの参照先を記載するので、
それを読みながら進めたいと思います。

Reference からはこちらを
- [Optional Braces](https://dotty.epfl.ch/docs/reference/other-new-features/indentation.html)
- [New Control Syntax](https://dotty.epfl.ch/docs/reference/other-new-features/control-syntax.html)

Migration guide からはこちらを参照します
- [Scala 3 Syntax Rewriting](https://scalacenter.github.io/scala-3-migration-guide/docs/scala-3-syntax-rewriting.html)

## Optional Braces

`src/main/scala` 配下の対応するコードも併せて見てみましょう

### 要点

- 中括弧 `{...}` をオプションとした
- 不正なインデントはコンパイラが warning を出力する
- compiler flag `-no-indent` でオプトアウトできる
- インデントブロックのすべての式や文が正確に並ぶことを要求しているわけではない
- コンパイラは、特定の予約語や改行時に `<indent>` または `<outdent>` トークンを自動的に挿入。文法的には、`<indent>` トークンと `<outdent>` トークンのペアは、中括弧 `{` と `}` のペアと同じ効果を持つ
- class、trait、object などに `:` をつけると次の行からボディを定義できる
- 同じソースファイル内でスペースとタブを混在させるのは避けるべき
- `match` や `catch` の 中括弧も省略可能
- インデント領域の範囲が「一目見て」すぐには分からないコードには、`end` マーカーを付ける
  - [ガイドライン](https://dotty.epfl.ch/docs/reference/other-new-features/indentation.html#the-end-marker) 参照
- コンパイラオプションの `rewrite` を使用することでコンパイラが自動的に書き換えてくれる
  - `-indent`、`-no-indent` を組み合わせる
- 関数の引数は例外的で、中括弧有りで書く
  - `-Yindent-colons` を付けることで、この制限すら外すこともできる

**:question: 公式ドキュメントが three-space indentation になってるの何ででしたっけ :question:**

## New Control Syntax

`src/main/scala` 配下の対応するコードも併せて見てみましょう

### 要点

-  "quiet" syntax が追加された
- `if` 式は、`then` を書く場合は条件に括弧を付けなくても良い
- `while` loop の条件は、`do` の後に続く場合は括弧を付けずに書くことができる
- `for` 式の列挙子は、`yield` や `do` の後に続く場合は、括弧や中括弧を入れずに書くことができる
- `for` 式の `do` は for-loop を表現している
- `catch` と同一行に 1つの `case` を書ける
- `catch` の `case` が複数の場合は、中括弧に入れるか、インデントブロックにしなければならない
- コンパイラオプションの `rewrite` を使用することでコンパイラが自動的に書き換えてくれる
  - `-new-syntax`、`-old-syntax` を組み合わせる

## Scala 3 Syntax Rewriting

- Syntax
  - インデントベース : `significant indentation based syntax (SIB syntax)`
  - Scala2 系の書き方 : `Classic syntax`
- Control structures
  - `if` や `for` などの新しい書き方 : `New control structures`
  - Scala2 系の書き方 : `Classic control structures`
- 1つのコードベースでこれらが混在するのは良くない
- Scala3 のコンパイラには自動で書き換えてくれる機能がある
